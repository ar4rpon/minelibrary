# MineLibrary プロジェクト固有ルール
/docs/ディレクトリ内のドキュメントも参照すること


## Claude Code 動作指針

### 基本方針
- **安全第一**: 本番環境に影響を与える可能性のある変更は慎重に行う
- **テスト重視**: 変更後は必ずテストを実行して動作確認
- **文書化**: 重要な実装や設計判断は適切に文書化
- **パフォーマンス**: N+1問題などのパフォーマンス問題を常に意識

### 作業時の必須手順
1. **変更前**: 現在のテスト状況を確認 (`vendor/bin/pest`)
2. **実装中**: 段階的にコミットし、各段階でテスト実行
3. **変更後**: 全てのテストが通ることを確認
4. **ドキュメント更新**: 必要に応じて関連ドキュメントを更新

### コード実装の優先順位
1. **機能の正確性**: 要件を正確に満たす
2. **セキュリティ**: 認証・認可・入力検証を適切に実装
3. **パフォーマンス**: N+1問題の回避、適切なクエリ最適化
4. **保守性**: 読みやすく、拡張しやすいコード
5. **テスト可能性**: テストしやすい設計

## プロジェクト固有の制約

### Laravel開発
- **Request クラス**: バリデーションは必ずRequestクラスで分離
- **Eager Loading**: 関連データの取得時は必ずeager loadingを使用
- **withCount()**: カウント処理は必ずwithCount()を使用
- **一括操作**: 複数レコードの操作時は一括処理を実装

### React/TypeScript開発
- **型安全性**: any型の使用は禁止、必ず適切な型定義
- **Inertia.js**: ページコンポーネントは`Inertia.render()`で描画
- **shadcn/ui**: UIコンポーネントは基本的にshadcn/uiを使用
- **Tailwind CSS**: スタイリングはTailwind CSSを使用

### データベース
- **SQLite**: 開発・テスト環境はSQLite使用
- **マイグレーション**: スキーマ変更は必ずマイグレーションで管理
- **インデックス**: パフォーマンスが重要な列にはインデックス追加

## 禁止パターン

### 絶対に避けるべきコード
```php
// ❌ N+1クエリ
foreach ($users as $user) {
    echo $user->posts->count();
}

// ❌ SQLインジェクションリスク
DB::raw("SELECT * FROM users WHERE id = " . $id);

// ❌ any型の使用
const data: any = response.data;
```

### 推奨パターン
```php
// ✅ Eager loading + withCount
$users = User::withCount('posts')->get();

// ✅ パラメータバインディング
$users = DB::select('SELECT * FROM users WHERE id = ?', [$id]);

// ✅ 適切な型定義
interface ApiResponse {
  data: User[];
  meta: {
    total: number;
    page: number;
  };
}
```

## エラー対応指針

### テストエラー時
1. エラーメッセージを詳細に確認
2. 該当テストファイルを特定
3. 最小限の修正で解決を試みる
4. 解決できない場合は、問題を明確にして報告

### パフォーマンス問題発生時
1. クエリログを確認 (`DB::enableQueryLog()`)
2. N+1問題の有無をチェック
3. `docs/PERFORMANCE_OPTIMIZATION_GUIDE.md`を参照
4. 段階的に最適化を実装

### セキュリティ問題発見時
1. 即座に修正を実施
2. 関連する他の箇所もチェック
3. テストで再発防止を確認
4. 必要に応じてセキュリティレビューを実施

---

**注意**: このファイルは定期的に見直し、プロジェクトの成長に合わせて更新してください。